name: Bump Kaku Cask

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Kaku version (e.g. 0.1.2 or V0.1.2)"
        required: true
        type: string
      sha256:
        description: "Optional DMG sha256 (leave empty to auto-download and calculate)"
        required: false
        type: string
  repository_dispatch:
    types: [kaku_release_published]

jobs:
  bump:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version and sha
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            raw_version='${{ github.event.client_payload.version }}'
            raw_sha='${{ github.event.client_payload.sha256 }}'
          else
            raw_version='${{ inputs.version }}'
            raw_sha='${{ inputs.sha256 }}'
          fi

          version="${raw_version#V}"
          version="${version#v}"

          if [[ -z "$version" ]]; then
            echo "version is empty"
            exit 1
          fi

          if [[ ! "$version" =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
            echo "invalid version: $version"
            exit 1
          fi

          if [[ -z "${raw_sha}" ]]; then
            dmg_url="https://github.com/tw93/Kaku/releases/download/V${version}/Kaku.dmg"
            tmpd="$(mktemp -d)"
            trap 'rm -rf "$tmpd"' EXIT
            curl -L --fail --silent --show-error "$dmg_url" -o "$tmpd/Kaku.dmg"
            sha="$(shasum -a 256 "$tmpd/Kaku.dmg" | awk '{print $1}')"
          else
            sha="$(echo "${raw_sha}" | tr '[:upper:]' '[:lower:]')"
          fi

          if [[ ! "$sha" =~ ^[a-f0-9]{64}$ ]]; then
            echo "invalid sha256: $sha"
            exit 1
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "sha256=$sha" >> "$GITHUB_OUTPUT"

      - name: Update cask file
        shell: bash
        run: |
          set -euo pipefail
          file="Casks/kaku.rb"
          version='${{ steps.vars.outputs.version }}'
          sha='${{ steps.vars.outputs.sha256 }}'

          perl -0pi -e 's/version "[^"]+"/version "'"$version"'"/' "$file"
          perl -0pi -e 's/sha256 "[^"]+"/sha256 "'"$sha"'"/' "$file"

      - name: Commit and push
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet -- Casks/kaku.rb; then
            echo "No changes."
            exit 0
          fi

          git config user.name "tw93"
          git config user.email "tw93@qq.com"
          git add Casks/kaku.rb
          git commit -m "chore(cask): bump kaku to v${{ steps.vars.outputs.version }}"
          git push
